<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Runway Video Generator</title>
</head>
<body>
<h2>Upload Foto → Generate Video</h2>

<input type="file" id="photo" accept="image/*">
<select id="duration">
  <option value="2">2 detik</option>
  <option value="4" selected>4 detik</option>
  <option value="6">6 detik</option>
</select>
<button onclick="generateVideo()">Generate</button>

<p id="status"></p>
<progress id="progressBar" value="0" max="100" style="width:300px;"></progress>
<br/>
<video id="result" controls style="max-width:400px; display:none;"></video>
<br/>
<a id="download" href="#" download="video.mp4" style="display:none;">⬇️ Download Video</a>

<script>
async function generateVideo() {
  const file = document.querySelector("#photo").files[0];
  const duration = document.getElementById("duration").value;
  if (!file) return alert("Pilih foto dulu!");

  // Compress image supaya lebih ringan (opsional)
  const canvas = document.createElement("canvas");
  const img = new Image();
  img.onload = async () => {
    const scale = Math.min(800 / img.width, 800 / img.height, 1);
    canvas.width = img.width * scale;
    canvas.height = img.height * scale;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    const base64 = canvas.toDataURL("image/png").split(",")[1];

    const statusEl = document.getElementById("status");
    const progressBar = document.getElementById("progressBar");
    statusEl.innerText = "Membuat task...";
    progressBar.value = 0;

    try {
      // 1. Buat task
      const createRes = await fetch("/api/createTask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ imageBase64: base64, prompt: "smooth cinematic zoom", duration })
      });
      const createData = await createRes.json();
      const taskId = createData.taskId;
      if (!taskId) return statusEl.innerText = "❌ Gagal buat task";

      statusEl.innerText = "Sedang diproses...";

      // 2. Polling status langsung ke Runway
      let videoUrl = null;
      while (!videoUrl) {
        const statusRes = await fetch(`https://api.dev.runwayml.com/v1/tasks/${taskId}`, {
          headers: {
            "Authorization": `Bearer ${process.env.RUNWAY_API_KEY}` // Bisa pakai serverless proxy jika ingin aman
          }
        });
        const status = await statusRes.json();
        progressBar.value = status.progress || progressBar.value;

        if (status.status === "succeeded") videoUrl = status.output[0].url;
        else if (status.status === "failed") {
          statusEl.innerText = "❌ Task gagal";
          return;
        }

        await new Promise(r => setTimeout(r, 3000)); // polling tiap 3 detik
      }

      statusEl.innerText = "✅ Selesai!";
      progressBar.value = 100;

      const video = document.getElementById("result");
      video.src = videoUrl;
      video.style.display = "block";

      const download = document.getElementById("download");
      download.href = videoUrl;
      download.style.display = "inline-block";

    } catch (err) {
      statusEl.innerText = "❌ Error: " + err;
    }
  };

  const reader = new FileReader();
  reader.onloadend = () => img.src = reader.result;
  reader.readAsDataURL(file);
}
</script>
</body>
</html>
